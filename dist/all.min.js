var CONFIG={FINANCIAL_SERVER_URL:"http://contentfinancial2-test.appspot.com/"},RiseVision=RiseVision||{};RiseVision.Common=RiseVision.Common||{},RiseVision.Common.Financial={},RiseVision.Common.Financial.Helper={},RiseVision.Common.Financial.RealTime={},RiseVision.Common.Financial.Historical={},RiseVision.Common.Financial.Historical.CollectionTimes={},RiseVision.Common.Financial.Helper=function(t){this.instruments=t},RiseVision.Common.Financial.Helper.prototype.setInstruments=function(t){this.instruments=t},RiseVision.Common.Financial.Helper.prototype.getInstruments=function(t,i){var e=this;if(t)return this.instruments.join("|");var s=(new Date).getDay(),n=i.length,o=[];return $.each(this.instruments,function(t,a){for(var l=0;n>l;l++)if(a==i[l].instrument){var r=i[l].startTime,c=i[l].endTime,m=i[l].daysOfWeek;$.each(m,function(i,n){return n==s?((new Date).between(r,c)&&o.push(e.instruments[t]),!1):void 0})}}),o.join("|")},RiseVision.Common.Financial.RealTime=function(t,i){this.displayID=t?t:"preview",i=i.split(","),$.each(i,function(t){i[t]=$.trim(i[t])}),this.instruments=i,this.isLoading=!0,this.conditions={},this.collectionTimes=[],this.updateInterval=6e4,this.now=Date.today(),this.url="http://contentfinancial2.appspot.com/data?",this.logosURL="https://s3.amazonaws.com/risecontentlogos/financial/",this.viz=new RiseVision.Common.Visualization,this.helper=new RiseVision.Common.Financial.Helper(this.instruments)},RiseVision.Common.Financial.RealTime.prototype.setInstruments=function(t){t=t.split(","),$.each(t,function(i){t[i]=$.trim(t[i])}),this.isLoading=!0,this.collectionTimes=[],this.instruments=t,this.helper.setInstruments(this.instruments)},RiseVision.Common.Financial.RealTime.prototype.getData=function(t,i,e,s){var n=this,o=!1,a=0,l="select instrument",r="";if(this.dataFields={},this.dataFields.instrument=0,this.startTimeIndex=1,this.isLoading&&(this.callback=s),$.each(t,function(t,i){o=!1,"instrument"==i||($.each(n.dataFields,function(t){return t==i?(o=!0,!1):void 0}),o||(l+=", "+i,n.dataFields[i]=a+1,a++,n.startTimeIndex++))}),this.logoCount=0,l+=", startTime, endTime, daysOfWeek, timeZoneOffset",!Date.equals(Date.today(),this.now)){this.now=Date.today();for(var c=0;c<this.collectionTimes.length;c++)this.collectionTimes[c].startTime.addDays(1),this.collectionTimes[c].endTime.addDays(1)}if(r=this.helper.getInstruments(this.isLoading,this.collectionTimes)){var n=this,m={url:this.url+"id="+this.displayID+"&codes="+r,refreshInterval:0,queryString:l,callback:function(t){n.onRealTimeDataLoaded(t,i,e)}};this.getDataTimer=setTimeout(function(){n.getData(t,i,e,s)},this.updateInterval),this.viz.getData(m)}else s(null)},RiseVision.Common.Financial.RealTime.prototype.onRealTimeDataLoaded=function(t,i,e){null!=t?(clearTimeout(this.getDataTimer),this.data=t,this.isLoading?(this.isLoading=!1,0==this.collectionTimes.length&&this.saveCollectionTimes(),i?this.loadLogos():this.callback&&this.callback(this.data,this.logoURLs)):i&&e?this.loadLogos():this.callback&&this.callback(this.data,this.logoURLs)):(console.log("Error encountered loading real-time data for: "),console.log(this.instruments[0]))},RiseVision.Common.Financial.RealTime.prototype.saveCollectionTimes=function(){var t,i,e,s;if(t=this.data.getNumberOfRows(),1==this.instruments.length&&this.data.getNumberOfRows()>1)"INVALID_SYMBOL"!=this.data.getValue(0,0)&&("..."==this.data.getValue(0,0)?this.isLoading=!0:(i=this.data.getValue(0,this.startTimeIndex+3),e=this.data.getValue(0,this.startTimeIndex),s=this.data.getValue(0,this.startTimeIndex+1),e&&s&&"N/P"!=i&&this.collectionTimes.push({instrument:this.instruments[0],startTime:e.setTimezoneOffset(i),endTime:s.setTimezoneOffset(i),daysOfWeek:this.data.getFormattedValue(0,this.startTimeIndex+2).split(",")})));else{for(var n=0;t>n;n++)"INVALID_SYMBOL"!=this.data.getValue(n,0)&&("..."==this.data.getValue(n,0)?this.isLoading=!0:(i=this.data.getValue(n,this.startTimeIndex+3),e=this.data.getValue(n,this.startTimeIndex),s=this.data.getValue(n,this.startTimeIndex+1),e&&s&&"N/P"!=i&&this.collectionTimes.push({instrument:this.instruments[n],startTime:e.setTimezoneOffset(i),endTime:s.setTimezoneOffset(i),daysOfWeek:this.data.getFormattedValue(n,this.startTimeIndex+2).split(",")})));0==this.collectionTimes.length&&console.log(this.collectionTimes)}},RiseVision.Common.Financial.RealTime.prototype.loadLogos=function(){var t=this.data.getNumberOfRows();this.logoCount=0,this.urls=new Array,this.logoURLs=new Array;for(var i=0;t>i;i++)this.urls.push(this.logosURL+this.data.getFormattedValue(i,0)+".svg");this.loadLogo(this.urls.length)},RiseVision.Common.Financial.RealTime.prototype.loadLogo=function(t){var i,e=this;i=new Image,i.onload=function(){e.logoURLs.push(i.src),e.onLogoLoaded(t)},i.onerror=function(){e.logoURLs.push(null),e.onLogoLoaded(t)},i.src=this.urls[this.logoCount]},RiseVision.Common.Financial.RealTime.prototype.onLogoLoaded=function(t){this.logoCount++,t--,0==t?this.callback&&this.callback(this.data,this.logoURLs):this.loadLogo(t)},RiseVision.Common.Financial.RealTime.prototype.checkSigns=function(t){var i,e,s=0,n=[];for(s=0,numRows=this.data.getNumberOfRows();numRows>s;s++)i=this.data.getValue(s,this.dataFields[t]),isNaN(i)&&(i=i.replace(/[^0-9\.-]+/g,""),i=parseFloat(i)),isNaN(i)||(e=i>=0?1:-1,n.push(e));return n},RiseVision.Common.Financial.RealTime.prototype.compare=function(t){var i=this,e=0,s=0,n=[],o=!1;if(this.conditions[t])for(row=0,numRows=this.data.getNumberOfRows();numRows>row;row++)e=this.data.getValue(row,this.dataFields[t]),o=!1,$.each(this.conditions[t],function(t,a){return a.instrument==i.data.getValue(row,0)?(s=a.value,isNaN(e)&&(e=e.replace(/[^0-9\.-]+/g,""),e=parseFloat(e)),isNaN(s)&&(s=s.replace(/[^0-9\.-]+/g,""),s=parseFloat(s)),isNaN(e)||isNaN(s)||(e!=s?e>s?n.push(1):n.push(-1):n.push(0)),o=!0,!1):void 0}),o||n.push(0);return this.saveBeforeValues([t]),n},RiseVision.Common.Financial.RealTime.prototype.saveBeforeValues=function(t){var i=this;$.each(t,function(t,e){i.conditions[e]=[],i.saveBeforeValue(e,i.dataFields[e])})},RiseVision.Common.Financial.RealTime.prototype.saveBeforeValue=function(t,i){for(var e=0,s=this.data.getNumberOfRows();s>e;e++)this.conditions[t].push({instrument:this.data.getValue(e,0),value:this.data.getValue(e,i)})},RiseVision.Common.Financial.Historical=function(t,i,e){this.displayID=t?t:"preview",this.instrument=i,this.duration=e,this.isLoading=!0,this.updateInterval=6e4,this.now=Date.today(),this.url="http://contentfinancial2.appspot.com/data/historical?",this.historicalViz=new RiseVision.Common.Visualization,this.helper=new RiseVision.Common.Financial.Helper([this.instrument])},RiseVision.Common.Financial.Historical.prototype.setInstrument=function(t){this.isLoading=!0,this.instrument=t,this.helper.setInstruments([this.instrument])},RiseVision.Common.Financial.Historical.prototype.setDuration=function(t){this.duration=t},RiseVision.Common.Financial.Historical.prototype.setIsUpdated=function(t){CollectionTimes.getInstance().setIsUpdated(this.instrument,t)},RiseVision.Common.Financial.Historical.prototype.getHistoricalData=function(t,i,e){var s=this,n="select "+t.join()+" ORDER BY tradeTime",o="";e&&(e.sortOrder&&"desc"==e.sortOrder&&(n+=" desc"),e.limit&&(n+=" LIMIT "+e.limit)),CollectionTimes.getInstance().addInstrument(this.instrument,this.now,function(a,l){s.now=l,o=s.helper.getInstruments(s.isLoading,[a]),o?(e={url:s.url+"id="+s.displayID+"&code="+s.instrument+"&kind="+s.duration,refreshInterval:0,queryString:n,callback:function(t){s.onHistoricalDataLoaded(t,a,i)}},s.getHistoricalDataTimer=setTimeout(function(){s.getHistoricalData(t,i,e)},s.updateInterval),s.historicalViz.getData(e)):i(null)})},RiseVision.Common.Financial.Historical.prototype.onHistoricalDataLoaded=function(t,i,e){var s=0;null!=t?(clearTimeout(this.getHistoricalDataTimer),this.historicalData=t,s=t.getNumberOfRows(),this.isLoading=0==s||1==s&&"0"==t.getFormattedValue(0,0)?!0:!1,null!=this.historicalData?e({data:this.historicalData,collectionData:i}):e({collectionData:i})):(console.log("Error encountered loading historical data for: "),console.log(this))};var CollectionTimes=function(){function t(){function t(e,s){var n,o=6e4,a=new RiseVision.Common.Visualization;collectionTimesTimer=setTimeout(function(){t(e,s)},o),n={url:"http://contentfinancial2.appspot.com/info?codes="+e,refreshInterval:0,queryString:"select startTime, endTime, daysOfWeek, timeZoneOffset, updateInterval",callback:function(t,n){a=null,null!=t?(clearTimeout(n),i(e,t),s()):console.log("Error encountered loading collection times for: "+e)},params:collectionTimesTimer},a.getData(n)}function i(t,i){var s,n,o,a;if(null!=i){s=i.getNumberOfRows();for(var l=0;l<e.length;l++)if(e[l].instrument==t){a=i.getValue(0,3),n=i.getValue(0,0),o=i.getValue(0,1),e[l].collectionTimes={instrument:t,startTime:n.setTimezoneOffset(a),endTime:o.setTimezoneOffset(a),daysOfWeek:i.getFormattedValue(0,2).split(","),timeZoneOffset:a,isUpdated:!0};break}}}return{setIsUpdated:function(t,i){for(var s=0;s<e.length;s++)e[s].instrument==t&&null!=e[s].collectionTimes&&(e[s].collectionTimes.isUpdated=i)},addInstrument:function(i,s,n){for(var o=0,a=!1,l=!1;o<e.length;o++)if(e[o].instrument==i){null!=e[o].collectionTimes&&(Date.equals(Date.today(),s)||e[o].collectionTimes.isUpdated||(s=Date.today(),e[o].collectionTimes.startTime.addDays(1),e[o].collectionTimes.endTime.addDays(1),e[o].collectionTimes.isUpdated=!0),l=!0),a=!0;break}l?n(e[o].collectionTimes,s):(a||e.push({instrument:i,collectionTimes:null}),t(i,function(){n(e[o].collectionTimes,s)}))}}}var i=!1,e=[];return{getInstance:function(){return i||(i=t()),i}}}();